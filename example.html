<!DOCTYPE html>
<html>
<head>
<style>
     body { background-color: rgb(252, 252, 252); font-family: sans-serif; padding: 20px; }
    h1 { color: rgb(0, 0, 0); text-align: left; }

    table { 
        font-family: 'Times New Roman', Times, serif;
        border-collapse: collapse;
        width: 100%;
    }

    td, th {
        border: 2px solid #8fc0cc;
        padding: 8px;
    }

    tr:nth-child(even){ background-color: beige; }

    th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: aquamarine;
        color: #333; 
        cursor: pointer;
    }
    
    th:hover { background-color: #7eb0bc; }

    input[type="text"] {
        padding: 8px;
        width: 300px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .pagination {
        margin-top: 20px;
    }
    button {
        margin: 0 5px;
        padding: 5px 10px;
    }
    .loading {
        color: #666;
        font-style: italic;
    }
</style>
</head>
<body>

<h1>Comment List</h1>

<table id="commentsTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Comments/Suggestions</th>
            <th>Ratings</th>
            <th>Department Head</th>
        </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
</table>

<div class="pagination">
    <button id="prevBtn" disabled>Previous</button>
    <span id="pageInfo">Loading...</span>
    <button id="nextBtn" disabled>Next</button>
</div>

<script>
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
async function fetchWithPause(url, pauseBeforeProcessing = 2000) {
    try {
        console.log("Sending request...");
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        console.log(`Response received. Pausing for ${pauseBeforeProcessing}ms...`);
        await delay(pauseBeforeProcessing); 

        const data = await response.json(); 
        console.log("Processed JSON:", data);
        return data;

    } catch (error) {
        console.error("Error fetching data:", error.message);
        throw error; 
    }
}

let allData = []; 
let currentPage = 1;
const itemsPerPage = 10; 
async function fetchData() {
    try {
        const proxy = 'https://corsproxy.io/?';
        const targetUrl = 'https://igsl-portal.igsl.asia/api-feedbacks-and-suggestions/?hash=7596a0413301cb255d859c7ac8f6131d92fe26c8b38a42dc9ec6f5faa5d0264a';
        
        const json = await fetchWithPause(proxy + encodeURIComponent(targetUrl), 3000); 
        return json.data || []; 
    } catch (error) {
        console.error('Error fetching data:', error);
        alert('Failed to load data. The proxy might be busy, or the API is down.');
        return [];
    }
}

function buildTable(data) {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    data.forEach(item => {
        const row = `<tr>
            <td>${item.idk || 'N/A'}</td>
            <td>${item.comments_suggs || "<em>No comment</em>"}</td>
            <td><strong>${item.ratings || 'N/A'}</strong></td>
            <td>${item.department_head_name || "N/A"}</td>
        </tr>`;
        tableBody.innerHTML += row;
    });
}

function getPaginatedData() {
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    return allData.slice(start, end);
}

function updatePagination() {
    const totalPages = Math.ceil(allData.length / itemsPerPage);
    document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById("prevBtn").disabled = currentPage <= 1;
    document.getElementById("nextBtn").disabled = currentPage >= totalPages;
}

function loadPage(page) {
    currentPage = page;
    const paginatedData = getPaginatedData();
    buildTable(paginatedData);
    updatePagination();
}

function filterTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById("commentsTable");
    const tr = table.getElementsByTagName("tr");

    for (let i = 1; i < tr.length; i++) { 
        const textContent = tr[i].textContent.toLowerCase();
        tr[i].style.display = textContent.includes(filter) ? "" : "none";
    }
}

document.getElementById("prevBtn").addEventListener("click", () => {
    if (currentPage > 1) loadPage(currentPage - 1);
});
document.getElementById("nextBtn").addEventListener("click", () => {
    const totalPages = Math.ceil(allData.length / itemsPerPage);
    if (currentPage < totalPages) loadPage(currentPage + 1);
});

(async () => {
    document.getElementById("pageInfo").textContent = 'Loading data...'; 
    allData = await fetchData();
    if (allData.length > 0) {
        loadPage(1);
    } else {
        document.getElementById("tableBody").innerHTML = '<tr><td colspan="4">No data available</td></tr>';
        document.getElementById("pageInfo").textContent = 'No pages';
    }
})();
</script>
</body>
</html>